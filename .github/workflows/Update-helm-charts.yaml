name: Update helm chart with new container
on:
  workflow_call:
    inputs:
      values_file_with_path:
        description: "Relative path Helm chart values file, including the file itself (Ex. elasticsearch/values-dev.yaml)"
        required: true
        type: string
      new_image_tag:
        description: "Image tag to add to helm chart"
        required: true
        type: string
      microservice_name:
        description: "Name of microservice corresponding to a container in ECR."
        required: true
        type: string
    secrets:
      GIT_USER_EMAIL:
        description: "Secret named GIT_USER_EMAIL for the CI user email."
        required: true
      GIT_USER_NAME:
        description: "Secret named ECR_REPO_BASE_NAME for the CI user name."
        required: true
      HELM_TOKEN:
        description: "Secret named HELM_TOKEN to access helm chart repository"
        required: true

# If update occurs from the trunk (main branch only), directly push otherwise create a PR
# Only allows calls from within CDCgov organization
jobs:  
  update-helm-chart:
    if: startsWith( github.repository, 'CDCgov' )
    name: Update Helm Charts
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: write
      pull-requests: write

    steps:
    - name: Checkout helm repository
      uses: actions/checkout@v4
      with:
        repository: CDCgov/NEDSS-Helm
        token: ${{secrets.HELM_TOKEN}} 
    
    - name: Set env variable
      run: echo "ran_push_to_main=false" >> $GITHUB_ENV     

    - name: Install yq
      run: |
        sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
        sudo chmod +x /usr/bin/yq

    - name: Update image tag for consolidated or flat chart
      run: |
        values_file="${{ inputs.values_file_with_path }}"
        svc_name="${{ inputs.microservice_name }}"
        new_tag="${{ inputs.new_image_tag }}"

        echo "========================================"
        echo "Helm Chart Update"
        echo "========================================"
        echo "Values file: $values_file"
        echo "Service name: $svc_name"
        echo "New tag: $new_tag"
        echo ""
        
        # Check if values file exists
        if [ ! -f "$values_file" ]; then
          echo "ERROR: Values file not found: $values_file"
          exit 1
        fi
        
        updated=false
        
        # For consolidated charts, try multiple service name variations
        if [ -n "$svc_name" ]; then
          # Prepare service name variations
          svc_name_exact="$svc_name"
          svc_name_no_suffix="${svc_name%-service}"  # Remove -service suffix if present
          
          echo "Attempting consolidated chart update..."
          echo "  Trying service key: '$svc_name_exact'"
          
          # Try exact name first
          if [ "$(yq e ".services.\"$svc_name_exact\".image.tag" "$values_file")" != "null" ]; then
            current_tag=$(yq e ".services.\"$svc_name_exact\".image.tag" "$values_file")
            echo "  ✓ Found service '$svc_name_exact'"
            echo "    Current tag: $current_tag"
            echo "    Updating to: $new_tag"
            yq e ".services.\"$svc_name_exact\".image.tag |= \"$new_tag\"" -i "$values_file"
            updated=true
          
          # If exact name didn't work and we have a -service suffix, try without it
          elif [ "$svc_name_exact" != "$svc_name_no_suffix" ]; then
            echo "  Service key '$svc_name_exact' not found"
            echo "  Trying service key: '$svc_name_no_suffix'"
            
            if [ "$(yq e ".services.\"$svc_name_no_suffix\".image.tag" "$values_file")" != "null" ]; then
              current_tag=$(yq e ".services.\"$svc_name_no_suffix\".image.tag" "$values_file")
              echo "  ✓ Found service '$svc_name_no_suffix'"
              echo "    Current tag: $current_tag"
              echo "    Updating to: $new_tag"
              yq e ".services.\"$svc_name_no_suffix\".image.tag |= \"$new_tag\"" -i "$values_file"
              updated=true
            fi
          fi
        fi
        
        # If still not updated, try flat chart structure
        if [ "$updated" = false ] && [ "$(yq e '.image.tag' "$values_file")" != "null" ]; then
          current_tag=$(yq e ".image.tag" "$values_file")
          echo "✓ Detected flat chart"
          echo "  Current tag: $current_tag"
          echo "  Updating to: $new_tag"
          yq e ".image.tag |= \"$new_tag\"" -i "$values_file"
          updated=true
        fi
        
        # Report results
        if [ "$updated" = true ]; then
          echo ""
          echo "✓ Successfully updated image tag to: $new_tag"
        else
          echo ""
          echo "✗ ERROR: Could not find image tag path in values file"
          echo ""
          echo "For consolidated charts, tried:"
          if [ -n "$svc_name" ]; then
            echo "  - .services.\"$svc_name\".image.tag"
            if [ "$svc_name" != "$svc_name_no_suffix" ]; then
              echo "  - .services.\"$svc_name_no_suffix\".image.tag"
            fi
          fi
          echo "For flat charts, tried:"
          echo "  - .image.tag"
          echo ""
          echo "Available services in values file:"
          yq e '.services | keys' "$values_file" 2>/dev/null || echo "  (no .services block found)"
          echo ""
          echo "Does values file have .image.tag?"
          yq e '.image.tag' "$values_file" 2>/dev/null || echo "  (no .image.tag found)"
          exit 1
        fi


    # If request is coming from the main trunk or is intended for dev environment
    - name: Commit and push changes to helm repository directly to main
      if: ${{ endsWith( github.ref, 'main') == true && contains(inputs.new_image_tag, 'SNAPSHOT') == true }}
      run: |
        echo ${{github.ref}}
        echo ${{ inputs.new_image_tag}}   
        git config --global user.name ${{ secrets.GIT_USER_NAME }}
        git config --global user.email  ${{ secrets.GIT_USER_EMAIL }}
        git remote set-url origin https://x-access-token:${{ secrets.HELM_TOKEN }}@github.com/CDCgov/NEDSS-Helm.git
        git add -A
        git commit -m "updating helm chart ${{ inputs.values_file_with_path}} with image tag ${{ inputs.new_image_tag}}"
        git push origin main --force
        
        echo "ran_push_to_main=true" >> $GITHUB_ENV

     # If request is NOT coming from the main trunk AND is NOT intended for dev environment
    - name: Commit and pull request to helm repository into main
      if: ${{ contains(env.ran_push_to_main, true) == false }}
      run: |
        git config --global user.name ${{ secrets.GIT_USER_NAME }}
        git config --global user.email  ${{ secrets.GIT_USER_EMAIL }}
        git checkout -b helm-update-${{inputs.microservice_name}}-${{ inputs.new_image_tag}}
        git add -A
        git commit -m "updating helm chart ${{ inputs.values_file_with_path}} with image tag ${{ inputs.new_image_tag}}"
        git push --set-upstream origin helm-update-${{inputs.microservice_name}}-${{ inputs.new_image_tag}}

        gh pr create -B main -H helm-update-${{inputs.microservice_name}}-${{ inputs.new_image_tag}} --title 'Merge helm-update-${{inputs.microservice_name}}-${{ inputs.new_image_tag}} into main' --body 'Created by Github action in ${{github.ref}}'
      env:
        GITHUB_TOKEN: ${{secrets.HELM_TOKEN}}
